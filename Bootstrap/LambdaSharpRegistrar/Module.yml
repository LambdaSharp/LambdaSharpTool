Module: LambdaSharpRegistrar
Version: 0.4-WIP
Description: LambdaSharp Modules and Functions Registrar
Pragmas:
  - no-module-registration

Inputs:

  - Input: RollbarReadAccessToken
    Type: Secret
    Section: Rollbar Settings
    Label: Read Access Token
    Description: Account-level token for read operations
    Scope: Register
    Default: ""

  - Input: RollbarWriteAccessToken
    Type: Secret
    Section: Rollbar Settings
    Label: Write Access Token
    Description: Account-level token for write operations
    Scope: Register
    Default: ""

  - Input: RollbarProjectPrefix
    Section: Rollbar Settings
    Label: Optional prefix when creating Rollbar projects
    Description:
    Scope: Register
    Default: ""

  - Input: RegistrationTableReadCapacity
    Section: Registration Table Settings
    Label: Read Capacity Units
    Description: Provisioned read capacity for registrations table
    Default: 1

  - Input: RegistrationTableWriteCapacity
    Section: Registration Table Settings
    Label: Write Capacity Units
    Description: Provisioned write capacity for registrations table
    Default: 1

Outputs:

  - CustomResource: LambdaSharp::Register::Module
    Description: Custom resources for registering LambdaSharp modules
    Handler: RegistrationTopic

  - CustomResource: LambdaSharp::Register::Function
    Description: Custom resources for registering LambdaSharp functions
    Handler: RegistrationTopic

  - Output: ErrorReportTopic

  - Output: UsageReportTopic

Variables:

  - Var: LoggingStreamReference
    Description: Reference to the Kinesis stream used to ingest the function logs
    Value: !Ref Module::LoggingStreamArn
    Resource:
      Type: AWS::Kinesis::Stream
      Allow: Subscribe

  - Var: RegistrationTopic
    Description: Custom resource topic for registering LambdaSharp modules
    Resource:
      Type: AWS::SNS::Topic
      Allow: Subscribe

  - Var: ErrorReportTopic
    Description: SNS topic for LambdaSharp module errors
    Scope: ProcessLogEvents
    Resource:
      Type: AWS::SNS::Topic
      Allow: Publish

  - Var: UsageReportTopic
    Description: SNS topic for LambdaSharp function usage reports
    Scope: ProcessLogEvents
    Resource:
      Type: AWS::SNS::Topic
      Allow: Publish

  - Var: RegistrationTable
    Description: DynamoDb table for storing function registrations
    Scope: *
    Resource:
      Type: AWS::DynamoDB::Table
      Allow: ReadWrite
      Properties:
        AttributeDefinitions:
          - AttributeName: Id
            AttributeType: S
        KeySchema:
          - AttributeName: Id
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: !Ref RegistrationTableReadCapacity
          WriteCapacityUnits: !Ref RegistrationTableWriteCapacity

Functions:

  - Function: ProcessLogEvents
    Description: Process log events from all LambdaSharp module functions
    Memory: 128
    Timeout: 30
    Pragmas:
        - no-function-registration
    Sources:
      - Kinesis: LoggingStreamReference

  - Function: Register
    Description: Register LambdaSharp modules and functions
    Memory: 128
    Timeout: 30
    Sources:
      - Topic: RegistrationTopic
